<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Produkt hinzufügen</title>
<style>
body{font-family:Arial,sans-serif;background:#f6f7fb;margin:0;padding:20px}
form{max-width:500px;background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
label{display:block;margin-top:10px}
input[type=text],input[type=file]{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc}
button{margin-top:12px;padding:10px 14px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}
.preview{margin-top:12px}
img{max-width:220px;height:120px;object-fit:contain;border-radius:6px}
</style>
</head>
<body>
<h1>Produkt hinzufügen</h1>
<form id="form-add">
<label for="name">Produktname</label>
<input id="name" type="text" placeholder="z. B. Bohrmaschine" required />

<label for="file">Bild auswählen</label>
<input id="file" type="file" accept="image/*" required />

<div class="preview" id="preview-area"></div>

<button type="submit">Speichern & schließen</button>
<button type="button" id="btn-save-continue">Speichern & weiteres Produkt</button>
<button type="button" id="btn-cancel">Abbrechen</button>
</form>

<script>
let dirHandle = null; // Ordnerhandle, muss vom Nutzer gewählt werden
const STORAGE_KEY='produkte_app_items_v1';
let lastImageData=null;

// Datei/Produkt laden
function loadProducts(){ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }

// Produkte speichern + JSON überschreiben
async function saveProducts(items){
  localStorage.setItem(STORAGE_KEY,JSON.stringify(items));
  if(!dirHandle) return;
  const fileHandle = await dirHandle.getFileHandle('produkte.json',{create:true});
  const writable = await fileHandle.createWritable();
  await writable.write(JSON.stringify(items,null,2));
  await writable.close();
}

// Bild als PNG speichern
async function saveImage(name,data){
  if(!dirHandle) return;
  const imgHandle = await dirHandle.getFileHandle(name+'.png',{create:true});
  const writable = await imgHandle.createWritable();
  const res = await fetch(data);
  const blob = await res.blob();
  await writable.write(blob);
  await writable.close();
}

// Neue ID generieren
function makeId(){ return 'p_'+Math.random().toString(36).slice(2,9); }

// Vorschau
const fileInput=document.getElementById('file');
const preview=document.getElementById('preview-area');
fileInput.addEventListener('change',e=>{
  const f=e.target.files && e.target.files[0];
  if(!f){ preview.innerHTML=''; lastImageData=null; return; }
  const reader=new FileReader();
  reader.onload=function(e){ lastImageData=e.target.result; preview.innerHTML='<img src="'+lastImageData+'" alt="Vorschau">'; }
  reader.readAsDataURL(f);
});

// Produkt hinzufügen
async function addProduct(name,imageData){
  if(!dirHandle){ 
    dirHandle = await window.showDirectoryPicker();
    alert('Ordner ausgewählt. Produkte und Bilder werden hier gespeichert.');
  }
  const items=loadProducts();
  const id=makeId();
  items.push({id,name,imageData});
  await saveProducts(items);
  await saveImage(name,imageData);
}

// Form Events
document.getElementById('form-add').addEventListener('submit', async e=>{
  e.preventDefault();
  const name=document.getElementById('name').value.trim();
  if(!name||!lastImageData){ alert('Produktname und Bild erforderlich.'); return; }
  await addProduct(name,lastImageData);
  alert('Produkt gespeichert.');
  window.close();
});

document.getElementById('btn-save-continue').addEventListener('click', async ()=>{
  const name=document.getElementById('name').value.trim();
  if(!name||!lastImageData){ alert('Produktname und Bild erforderlich.'); return; }
  await addProduct(name,lastImageData);
  document.getElementById('name').value='';
  document.getElementById('file').value='';
  preview.innerHTML='';
  lastImageData=null;
  alert('Produkt gespeichert – weiteres Produkt hinzufügen.');
});

document.getElementById('btn-cancel').addEventListener('click',()=>{ window.close(); });
</script>
</body>
</html>

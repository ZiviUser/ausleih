<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Produkt hinzufügen</title>
<style>
body{font-family:Inter,sans-serif;background:#f6f7fb;margin:0;display:flex;align-items:center;justify-content:center;min-height:100vh;}
form{background:white;padding:20px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.08);max-width:400px;width:100%;}
label{display:block;margin-top:10px;font-weight:600;}
input{width:100%;padding:8px;margin-top:4px;border:1px solid #ddd;border-radius:8px;}
button{margin-top:16px;width:100%;padding:10px;background:#2563eb;color:white;font-weight:600;border:none;border-radius:10px;cursor:pointer;}
a{display:block;text-align:center;margin-top:10px;color:#2563eb;text-decoration:none;}
.preview{margin-top:10px;text-align:center;}
.preview img{max-width:100%;border-radius:8px;margin-top:6px;}
</style>

<!-- Supabase v1 CDN: muss VOR deinem Script stehen -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/supabase.min.js"></script>

</head>
<body>
<form id="addForm">
<h2>Neues Produkt</h2>
<label for="name">Name</label>
<input type="text" id="name" required>

<label for="imageFile">Bild hochladen</label>
<input type="file" id="imageFile" accept="image/*">
<div class="preview" id="imagePreview"></div>

<button type="submit">Speichern</button>
<a href="index.html">Zurück</a>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const SUPABASE_URL = 'https://wjjquuzhnezjgqtawury.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndqanF1dXpobmV6amdxdXJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwOTYzNTksImV4cCI6MjA3MzY3MjM1OX0.TAxk9lGRRD5hWAq8PbaysICEzjvd7A2j9OF30MQmiCk';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const addForm = document.getElementById('addForm');
  const imageInput = document.getElementById('imageFile');
  const imagePreview = document.getElementById('imagePreview');
  let selectedFile = null;

  function cryptoRandomId(){ return 'p_'+Math.random().toString(36).slice(2,10); }

  imageInput.addEventListener('change', e=>{
    selectedFile = e.target.files[0];
    if(selectedFile){
      const reader = new FileReader();
      reader.onload = ev => imagePreview.innerHTML = `<img src="${ev.target.result}" alt="Vorschau">`;
      reader.readAsDataURL(selectedFile);
    }
  });

  addForm.addEventListener('submit', async e=>{
    e.preventDefault();
    const name = document.getElementById('name').value.trim();
    if(!name) return alert("Bitte Name eingeben");

    let imageUrl = 'https://via.placeholder.com/400x300?text=Kein+Bild';

    try {
      if(selectedFile){
        const filename = cryptoRandomId() + '-' + selectedFile.name;
        const { data: uploadData, error: uploadError } = await supabaseClient
          .storage.from('product-images')
          .upload(filename, selectedFile);

        if(uploadError) throw uploadError;

        const { publicURL } = supabaseClient
          .storage.from('product-images')
          .getPublicUrl(filename);

        imageUrl = publicURL;
      }

      const { data, error } = await supabaseClient.from('products').insert([{
        id: cryptoRandomId(),
        name,
        image: imageUrl,
        borrower: '',
        borrowedSince: null
      }]);

      if(error) throw error;

      alert('Produkt erfolgreich gespeichert!');
      window.location.href = 'index.html';
    } catch(err){
      console.error(err);
      alert('Fehler beim Speichern: ' + err.message);
    }
  });
});
</script>
</body>
</html>
